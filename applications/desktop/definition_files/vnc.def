# tag: 1.1

Bootstrap: docker
From: rockylinux/rockylinux:9

%post
DUST_VER="v1.2.4"

OS=linux
# Detect architecture
detect_arch() {
    ARCH=$(uname -m)
    case "$ARCH" in
        x86_64|amd64)   ARCH="x86_64" ;;
        aarch64|arm64)  ARCH="aarch64" ;;
        armv7l)         ARCH="arm" ;;
        i686|i386)      ARCH="i686" ;;
        *)              error "Unsupported architecture: $ARCH" ;;
    esac
}

(
    curl -L https://raw.githubusercontent.com/TurboVNC/repo/main/TurboVNC.repo
    echo "exclude=turbovnc-*.*.9[0-9]-*"
) >/etc/yum.repos.d/TurboVNC.repo

dnf upgrade -y
dnf install -y epel-release && crb enable
dnf groupinstall -y Xfce --exclude=xfce4-power-manager
dnf -y install procps-ng perl turbovnc novnc firefox \
  baobab openssh-clients tree vim-enhanced ripgrep wget which bash awscli2 \
  jq jello python3.12 ca-certificates \
  java-21-openjdk iputils bind-utils \
  nvtop htop procps-ng bat ripgrep fzf \
  parole vim-X11 zip tar gzip pigz git \
  rocky-backgrounds
dnf clean all -y
rm /etc/xdg/autostart/xfce-polkit.desktop

# Things that aren't available in repositories
# dust
mkdir -p /usr/local/bin
tmp="$(mktemp -d)"
cd $tmp
detect_arch
wget -q -O "dust.tar.gz" \
  https://github.com/bootandy/dust/releases/download/${DUST_VER}/dust-${DUST_VER}-${ARCH}-unknown-linux-musl.tar.gz
tar -xzf dust.tar.gz
cp "$(find . -name "dust" | head -n 1)" /usr/local/bin/dust
chmod +x /usr/local/bin/dust
rm -rf ./*

# xfce config


# theming
git clone --depth 1 https://github.com/daniruiz/flat-remix-gtk.git
cp -r flat-remix-gtk/themes/Flat-Remix-GTK-Green-Dark/ /usr/share/themes

git clone --depth 1 https://github.com/daniruiz/flat-remix.git
cp -r flat-remix/Flat-Remix-Green-Dark /usr/share/icons

cat >/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-screensaver.xml <<__EOF__
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfce4-screensaver" version="1.0">
  <property name="lock" type="empty">
    <property name="sleep-activation" type="bool" value="false"/>
    <property name="enabled" type="bool" value="false"/>
  </property>
  <property name="saver" type="empty">
    <property name="mode" type="int" value="0"/>
  </property>
</channel>
__EOF__

cat >/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml <<__EOF__
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="ThemeName" type="string" value="Flat-Remix-GTK-Green-Dark"/>
    <property name="IconThemeName" type="string" value="Flat-Remix-Green-Dark"/>
  </property>
  <property name="Gtk" type="empty">
    <property name="FontName" type="string" value="Sans 10"/>
    <property name="CursorThemeName" type="string" value="Adwaita"/>
  </property>
</channel>
__EOF__

cat >/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml <<__EOF__
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfwm4" version="1.0">
  <property name="general" type="empty">
    <property name="theme" type="string" value="Arc-Dark"/>
  </property>
</channel>
__EOF__

cat >/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml <<__EOF__
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xfce4-desktop" version="1.0">
  <property name="backdrop" type="empty">
    <property name="screen0" type="empty">
      <property name="monitorVNC-0" type="empty">
        <property name="workspace0" type="empty">
          <property name="color-style" type="int" value="0"/>
          <property name="image-style" type="int" value="5"/>
          <property name="last-image" type="string" value="/usr/share/backgrounds/rocky-default-9-onyx-mountains.png"/>
        </property>
      </property>
    </property>
  </property>
</channel>
__EOF__

# make novnc default to using remote resize
sed -i.bak -E "s/UI.initSetting\('resize',[[:space:]]*'off'\)/UI.initSetting('resize', 'remote')/" \
  /usr/share/novnc/app/ui.js


# script used by workflow
cat >/usr/local/bin/start-vncserver.sh <<'__EOF__'
#!/bin/sh
/usr/bin/novnc_proxy --vnc localhost:5900 --listen ${1:-6080} &
PROXY=$?
/opt/TurboVNC/bin/vncserver -securitytypes tlsnone,x509none,none -wm xfce -fg ${VNCSERVER_ARGS} :0
kill $PROXY
__EOF__
chmod +x /usr/local/bin/start-vncserver.sh


# /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml

%runscript




