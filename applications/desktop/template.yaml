# Copyright 2025 CIQ, Inc. All rights reserved.
{{- $datavol := trim .DataVolume }}
{{- $homevol := trim .HomeVolume }}
{{- if and $datavol (not (hasPrefix "volume://" $datavol)) }}
  {{- fail (printf "DataVolume must start with 'volume://', got %q" $datavol) }}
{{- end }}
{{- if and $homevol (not (hasPrefix "volume://" $homevol)) }}
  {{- fail (printf "HomeVolume must start with 'volume://', got %q" $homevol) }}
{{- end }}

{{- $datamount := "/data" }}
{{- $home := "/home/fb" }}
{{- if not $homevol }}
  {{ $home = "/tmp/homefb" }}
{{- end }}
{{- $port := randInt 10000 32000 }}

version: v1

{{- if (or $datavol $homevol) }}
volumes:
  {{- if $datavol }}
  data:
    reference: {{ $datavol }}
  {{- end }}
  {{- if $homevol }}
  home:
    reference: {{ $homevol }}
  {{- end }}
{{- end }}

services:
  vnc:
{{- if (or $datavol $homevol) }}
    mounts:
  {{- if $datavol }}
      data:
        location: {{ $datamount }}
  {{- end }}
  {{- if $homevol }}
      home:
        location: {{ $home }}
  {{- end }}
{{- end }}
    persist: true
    network:
      ports:
        - name: vnc-port
          protocol: tcp
          port: {{ $port }}
      endpoints:
        - name: vnc
          port-name: vnc-port
          protocol: http
          type: subdomain
          scope: user
    env:
      - HOME={{ $home }}
    image:
      uri: {{ .Container }}
    script: |
      #!/bin/sh
      mkdir -p "$HOME"
      echo "Starting desktop and vnc"
      /usr/local/bin/start-vncserver.sh {{ $port }}
    resource:
      cpu:
        cores: {{ .Cores }}
      memory:
        size: {{ .Memory }}
      exclusive: {{ .Exclusive }}
